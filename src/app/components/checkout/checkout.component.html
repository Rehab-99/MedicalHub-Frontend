<section class="custom-accordion">
  <!-- Popup Message -->
  <div *ngIf="showPopup" class="popup-overlay">
    <div class="popup" [ngClass]="{'success': popupType === 'success', 'error': popupType === 'error'}">
      <div class="popup-content">
        <div class="popup-icon">
          <i *ngIf="popupType === 'success'" class="fas fa-check-circle"></i>
          <i *ngIf="popupType === 'error'" class="fas fa-exclamation-circle"></i>
        </div>
        <div class="popup-message">{{ popupMessage }}</div>
      </div>
    </div>
  </div>

  <!-- Billing Address -->
  <div class="accordion-box">
    <input type="checkbox" id="billing-toggle" class="accordion-toggle" required>
    <label for="billing-toggle" class="accordion-header">Billing Address</label>
    <div class="accordion-body">
      <form [formGroup]="billingForm">
        <div class="form-grid">
          <div class="form-row two-columns">
            <div class="form-field">
              <input type="text" formControlName="first_name" placeholder="First Name" />
              <div class="error-message" *ngIf="isFieldInvalid(billingForm, 'first_name')">
                {{ getErrorMessage(billingForm, 'first_name') }}
              </div>
            </div>
            <div class="form-field">
              <input type="text" formControlName="last_name" placeholder="Last Name" />
              <div class="error-message" *ngIf="isFieldInvalid(billingForm, 'last_name')">
                {{ getErrorMessage(billingForm, 'last_name') }}
              </div>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <input type="email" formControlName="email" placeholder="Email Address" />
              <div class="error-message" *ngIf="isFieldInvalid(billingForm, 'email')">
                {{ getErrorMessage(billingForm, 'email') }}
              </div>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <input type="text" formControlName="phone_number" placeholder="Phone Number" />
              <div class="error-message" *ngIf="isFieldInvalid(billingForm, 'phone_number')">
                {{ getErrorMessage(billingForm, 'phone_number') }}
              </div>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <input type="text" formControlName="address" placeholder="Mailing Address" />
              <div class="error-message" *ngIf="isFieldInvalid(billingForm, 'address')">
                {{ getErrorMessage(billingForm, 'address') }}
              </div>
            </div>
          </div>
          <div class="form-row two-columns">
            <div class="form-field">
              <input type="text" formControlName="city" placeholder="City" />
              <div class="error-message" *ngIf="isFieldInvalid(billingForm, 'city')">
                {{ getErrorMessage(billingForm, 'city') }}
              </div>
            </div>
            <div class="form-field">
              <input type="text" formControlName="post_code" placeholder="Post Code" />
              <div class="error-message" *ngIf="isFieldInvalid(billingForm, 'post_code')">
                {{ getErrorMessage(billingForm, 'post_code') }}
              </div>
            </div>
          </div>
          <div class="form-row two-columns">
            <div class="form-field">
              <input type="text" formControlName="country" placeholder="Country" />
              <div class="error-message" *ngIf="isFieldInvalid(billingForm, 'country')">
                {{ getErrorMessage(billingForm, 'country') }}
              </div>
            </div>
            <div class="form-field">
              <input type="text" formControlName="state" placeholder="State" />
              <div class="error-message" *ngIf="isFieldInvalid(billingForm, 'state')">
                {{ getErrorMessage(billingForm, 'state') }}
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Shipping Address -->
  <div class="accordion-box">
    <input type="checkbox" id="shipping-toggle" class="accordion-toggle">
    <label for="shipping-toggle" class="accordion-header">Shipping Address</label>
    <div class="accordion-body">
      <form [formGroup]="shippingForm">
        <div class="form-grid">
          <div class="form-row two-columns">
            <div class="form-field">
              <input type="text" formControlName="first_name" placeholder="First Name" />
              <div class="error-message" *ngIf="isFieldInvalid(shippingForm, 'first_name')">
                {{ getErrorMessage(shippingForm, 'first_name') }}
              </div>
            </div>
            <div class="form-field">
              <input type="text" formControlName="last_name" placeholder="Last Name" />
              <div class="error-message" *ngIf="isFieldInvalid(shippingForm, 'last_name')">
                {{ getErrorMessage(shippingForm, 'last_name') }}
              </div>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <input type="email" formControlName="email" placeholder="Email Address" />
              <div class="error-message" *ngIf="isFieldInvalid(shippingForm, 'email')">
                {{ getErrorMessage(shippingForm, 'email') }}
              </div>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <input type="text" formControlName="phone_number" placeholder="Phone Number" />
              <div class="error-message" *ngIf="isFieldInvalid(shippingForm, 'phone_number')">
                {{ getErrorMessage(shippingForm, 'phone_number') }}
              </div>
            </div>
          </div>
          <div class="form-row">
            <div class="form-field">
              <input type="text" formControlName="address" placeholder="Mailing Address" />
              <div class="error-message" *ngIf="isFieldInvalid(shippingForm, 'address')">
                {{ getErrorMessage(shippingForm, 'address') }}
              </div>
            </div>
          </div>
          <div class="form-row two-columns">
            <div class="form-field">
              <input type="text" formControlName="city" placeholder="City" />
              <div class="error-message" *ngIf="isFieldInvalid(shippingForm, 'city')">
                {{ getErrorMessage(shippingForm, 'city') }}
              </div>
            </div>
            <div class="form-field">
              <input type="text" formControlName="post_code" placeholder="Post Code" />
              <div class="error-message" *ngIf="isFieldInvalid(shippingForm, 'post_code')">
                {{ getErrorMessage(shippingForm, 'post_code') }}
              </div>
            </div>
          </div>
          <div class="form-row two-columns">
            <div class="form-field">
              <input type="text" formControlName="country" placeholder="Country" />
              <div class="error-message" *ngIf="isFieldInvalid(shippingForm, 'country')">
                {{ getErrorMessage(shippingForm, 'country') }}
              </div>
            </div>
            <div class="form-field">
              <input type="text" formControlName="state" placeholder="State" />
              <div class="error-message" *ngIf="isFieldInvalid(shippingForm, 'state')">
                {{ getErrorMessage(shippingForm, 'state') }}
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Payment Method -->
  <div class="accordion-box">
    <input type="checkbox" id="payment-toggle" class="accordion-toggle">
    <label for="payment-toggle" class="accordion-header">Payment Method</label>
    <div class="accordion-body">
      <form>
        <div class="form-grid">
          <div class="form-row">
            <select name="payment_method" [(ngModel)]="checkoutData.payment_method" (change)="onPaymentMethodChange()">
              <option value="">Select Payment Method</option>
              <option value="stripe">Credit Card (Stripe)</option>
              <option value="cash">Cash on Delivery</option>
            </select>
          </div>
        </div>
      </form>

      <!-- Stripe Payment Form -->
      <div *ngIf="showStripeForm" class="stripe-payment-form">
        <div #paymentElement id="payment-element"></div>
      </div>
    </div>
  </div>

  <!-- Order Summary -->
  <div class="accordion-box">
    <input type="checkbox" id="summary-toggle" class="accordion-toggle" checked>
    <label for="summary-toggle" class="accordion-header">Order Summary</label>
    <div class="accordion-body">
      <div class="order-summary">
        <div *ngIf="cartItems.length === 0" class="empty-cart">
          Your cart is empty
        </div>
        <div class="summary-item" *ngFor="let item of cartItems">
          <div class="item-details">
            <span class="item-name">{{item.name || 'Product ' + item.productId}}</span>
            <span class="item-quantity">x{{item.quantity}}</span>
          </div>
          <span class="item-price">EGP {{item.price * item.quantity}}</span>
        </div>
        
        <!-- عرض الخصم إذا كان موجودًا -->
        <div class="summary-item discount" *ngIf="discount > 0">
          <div class="item-details">
            <span class="item-name">Discount</span>
          </div>
          <span class="item-price discount">-EGP {{discount}}</span>
        </div>
        
        <div class="summary-total">
          <span>Total:</span>
          <span>EGP {{totalPrice}}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Checkout Button -->
  <div class="checkout-button-container">
    <button class="checkout-button" 
            (click)="processCheckout()" 
            [disabled]="isLoading || cartItems.length === 0 || billingForm.invalid || shippingForm.invalid">
      <span *ngIf="!isLoading">Complete Checkout</span>
      <span *ngIf="isLoading" class="loading-spinner"></span>
    </button>
  </div>
</section>
