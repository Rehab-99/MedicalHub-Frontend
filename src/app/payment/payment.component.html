<div class="acount-login section">

  <div class="container">
      <div class="row">
          <div class="col-lg-6 offset-lg-3 col-md-8 offset-md-2">
              <div id="payment-message" class="alert-info" class="hidden"></div>
              <form id="payment-form">

              <div class="payment-element">

              </div>
              <button id="submit">
                  <div class="spinner hidden" id="spinner">processing</div>
                  <span id="button-text">Pay now</span>
                </button>
              </form>

          </div>
      </div>
  </div>
</div>
<script src="https://js.stripe.com/v3/"></script>
<script >
  // This is your test publishable API key.
const stripe = Stripe("pk_test_51REdqh4G94LRAOydMDcGvERRCV7snk6EdwN5g217aIF7ULYL1nLwiYb1Xgnu5aR2nTbT1osbmS60J6XnNgGLoZOj00Z24z4TCv");

// The items the customer wants to buy
const items = [{ id: "xl-tshirt", amount: 1000 }];

let elements;

initialize();

document
.querySelector("#payment-element")
.addEventListener("submit", handleSubmit);

// Fetches a payment intent and captures the client secret
async function initialize() {
const { clientSecret } = await fetch("{{route('payments.stripe.intent'),$order->id}}", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ 
      "_token":"{{csrf_token()}}"
   }),
}).then((r) => r.json());

elements = stripe.elements({ clientSecret });

const paymentElementOptions = {
  layout: "accordion",
}; 

const paymentElement = elements.create("payment", paymentElementOptions);
paymentElement.mount("#payment-element");
}

async function handleSubmit(e) {
e.preventDefault();
setLoading(true);

const { error } = await stripe.confirmPayment({
  elements,
  confirmParams: {
    // Make sure to change this to your payment completion page
    return_url: "{{{route('payments.stripe.confirm'),$order->id}}}",
  },
});

// This point will only be reached if there is an immediate error when
// confirming the payment. Otherwise, your customer will be redirected to
// your `return_url`. For some payment methods like iDEAL, your customer will
// be redirected to an intermediate site first to authorize the payment, then
// redirected to the `return_url`.
if (error.type === "card_error" || error.type === "validation_error") {
  showMessage(error.message);
} else {
  showMessage("An unexpected error occurred.");
}

setLoading(false);
}

// ------- UI helpers -------

function showMessage(messageText) {
const messageContainer = document.querySelector("#payment-message");

messageContainer.classList.remove("hidden");
messageContainer.textContent = messageText;

setTimeout(function () {
  messageContainer.classList.add("hidden");
  messageContainer.textContent = "";
}, 4000);
}

// Show a spinner on payment submission
function setLoading(isLoading) {
if (isLoading) {
  // Disable the button and show a spinner
  document.querySelector("#submit").disabled = true;
  document.querySelector("#spinner").classList.remove("hidden");
  document.querySelector("#button-text").classList.add("hidden");
} else {
  document.querySelector("#submit").disabled = false;
  document.querySelector("#spinner").classList.add("hidden");
  document.querySelector("#button-text").classList.remove("hidden");
}
}
</script>